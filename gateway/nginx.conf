# HTTPS Gateway for Local Development
# Run with: nginx -p /path/to/jolli/gateway -c nginx.conf

worker_processes 1;

# Cross-platform default (works on Windows, Linux, and macOS):
error_log logs/error.log;
pid logs/nginx.pid;
# Alternative for Linux/macOS (uncomment these and comment out the above if preferred):
# error_log /dev/stderr;
# pid /tmp/nginx-gateway.pid;

events {
    worker_connections 1024;
}

http {
    # Cross-platform default (works on Windows, Linux, and macOS):
    access_log logs/access.log;
    # Alternative for Linux/macOS (uncomment this and comment out the above if preferred):
    # access_log /dev/stdout;

    # Upstream servers
    upstream manager {
        server 127.0.0.1:3034;
    }
    upstream frontend {
        server 127.0.0.1:8034;
    }
    upstream backend {
        server 127.0.0.1:7034;
    }

    # SSL settings (shared across all server blocks)
    ssl_certificate     certs/domain.cert.pem;
    ssl_certificate_key certs/private.key.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # Admin subdomain -> Manager app (Next.js on port 3034)
    server {
        listen 443 ssl;
        server_name admin.*;

        location / {
            proxy_pass http://manager;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # WebSocket support for Next.js HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # API subdomain -> Backend directly (for manager-to-backend calls and direct API access)
    server {
        listen 443 ssl;
        server_name api.*;

        location / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # SSE support - disable buffering for streaming responses
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400s;
        }
    }

    # Auth gateway subdomain -> All routes through frontend (Vite proxies to backend with proper headers)
    # Note: /auth/ routes are now accessible from all domains (see default server /auth/ block)
    server {
        listen 443 ssl;
        server_name auth.*;

        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # Disable buffering to prevent content length mismatch with Vite
            proxy_buffering off;
        }
    }

    # All other subdomains -> Frontend app (with API routing to backend)
    server {
        listen 443 ssl default_server;
        server_name _;

        # API routes -> Frontend (Vite dev server proxies /api/ to backend on port 7034)
        location /api/ {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # SSE support - disable buffering for streaming responses
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400s;
        }

        # OAuth routes -> Frontend (Vite proxies to backend with proper headers)
        location /connect/ {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Auth routes -> Frontend (Vite proxies to backend with proper headers)
        location /auth/ {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Everything else -> Frontend (Vite on port 8034)
        location / {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # Disable buffering to prevent content length mismatch with Vite
            proxy_buffering off;
        }
    }
}
