# jolli-docs-diff-generator

Generates version-to-version diffs for documentation content graphs.

## Purpose

Part of the jolli documentation pipeline, this tool:
- Compares two versions of compiled content graphs
- Identifies added, removed, and modified sections
- Tracks content changes via SHA256 hashes
- Provides structured diff output for analysis
- Enables documentation evolution tracking

## Installation

```bash
cd tools/jolli-docs-diff-generator
npm install
npm run build
```

## Command Line Usage

```bash
npx jolli-docs-diff-generator \
  --source <source-name> \
  --from <version1> \
  --to <version2> \
  --artifactsDir <artifacts-directory>
```

### Options

- `--source <name>` - Source identifier (e.g., "openapi-demo") [required]
- `--from <version>` - Source version (e.g., "v1") [required]
- `--to <version>` - Target version (e.g., "v2") [required]
- `--artifactsDir <path>` - Path to artifacts directory (default: "artifacts")
- `--help`, `-h` - Display help message

### Example

```bash
npx jolli-docs-diff-generator \
  --source openapi-demo \
  --from v1 \
  --to v2 \
  --artifactsDir artifacts
```

## Input Files

Requires `graph.json` from both versions:
- `<artifactsDir>/<source>/<from>/graph.json`
- `<artifactsDir>/<source>/<to>/graph.json`

Generated by `jolli-docs-compiler`.

## Output File

`diffs/<from>__<to>.json` in `<artifactsDir>/<source>/`:

```json
{
  "from_version": "v1",
  "to_version": "v2",
  "generated_at": "2025-12-17T12:00:00.000Z",
  "added": [
    {
      "section_id": "api/new-endpoint::overview",
      "doc_path": "api/new-endpoint.mdx",
      "heading": "Overview",
      "heading_level": 2,
      "content_hash": "sha256:def456...",
      "covers": ["openapi:NewService_newOp"],
      "word_count": 120
    }
  ],
  "removed": [
    {
      "section_id": "api/old-endpoint::overview",
      "doc_path": "api/old-endpoint.mdx",
      "heading": "Overview",
      "heading_level": 2,
      "content_hash": "sha256:old123...",
      "covers": ["openapi:OldService_oldOp"],
      "word_count": 80
    }
  ],
  "modified": [
    {
      "section_id": "api/rate-limit/get-limits::overview",
      "doc_path": "api/rate-limit/get-limits.mdx",
      "old_hash": "sha256:abc123...",
      "new_hash": "sha256:xyz789...",
      "old_word_count": 150,
      "new_word_count": 175
    }
  ],
  "summary": {
    "added_count": 1,
    "removed_count": 1,
    "modified_count": 1,
    "unchanged_count": 42
  }
}
```

## Change Detection

Sections are categorized by comparing section IDs and content hashes:

- **Added**: In `to` version, not in `from` version
- **Removed**: In `from` version, not in `to` version
- **Modified**: In both versions, but content hash differs
- **Unchanged**: In both versions with identical hash (not in output)

## Library Usage

```typescript
import { generateDiff } from 'jolli-docs-diff-generator';

const result = await generateDiff({
  source: 'openapi-demo',
  fromVersion: 'v1',
  toVersion: 'v2',
  artifactsDir: 'artifacts',
});

console.log(`Added: ${result.addedCount}`);
console.log(`Removed: ${result.removedCount}`);
console.log(`Modified: ${result.modifiedCount}`);
console.log(`Output: ${result.outputFile}`);
```

## Documentation Pipeline Integration

This tool is the fourth step in the jolli documentation pipeline:

1. jolli-docs-bootstrapper → Generate initial MDX docs
2. jolli-docs-compiler → Build versioned content graph
3. jolli-docs-impact-analyzer → Detect impacted sections
4. **jolli-docs-diff-generator** → Generate version diffs

## Use Cases

### 1. Documentation Evolution Tracking
Track how documentation changes over time:
```bash
# Compare sequential versions
npx jolli-docs-diff-generator --source api --from v1 --to v2
npx jolli-docs-diff-generator --source api --from v2 --to v3
```

### 2. Release Notes Generation
Automatically generate documentation changelog:
```typescript
const diff = loadDiff('artifacts/api/diffs/v1__v2.json');
const releaseNotes = `
## Documentation Changes in v2

### New Sections (${diff.added.length})
${diff.added.map(s => `- ${s.heading}`).join('\n')}

### Updated Sections (${diff.modified.length})
${diff.modified.map(s => `- ${s.section_id}`).join('\n')}
`;
```

### 3. Review Prioritization
Identify major documentation updates:
```typescript
const diff = loadDiff('artifacts/api/diffs/v1__v2.json');

// Find sections with significant changes
const majorChanges = diff.modified.filter(section => {
  const wordDiff = Math.abs(
    section.new_word_count - section.old_word_count
  );
  return wordDiff > 50; // More than 50 words changed
});

console.log(`${majorChanges.length} sections need thorough review`);
```

### 4. Audit Trail
Maintain history of documentation changes:
```bash
# Generate diffs for all version pairs
for v in v1 v2 v3 v4; do
  next_v=$(increment_version $v)
  npx jolli-docs-diff-generator --source api --from $v --to $next_v
done

# Diffs directory now contains complete evolution history
```

## Diff File Naming

Output files follow the pattern: `<from>__<to>.json`

Examples:
- `v1__v2.json` - v1 to v2
- `v2__v3.json` - v2 to v3
- `2024-01__2024-02.json` - Date-based versions

## Testing

```bash
npm test          # Run tests
npm run build     # Build distribution
```

**Test Coverage**: 98%+ lines, 100% functions, 94%+ branches

## How It Works

1. **Load Graphs**: Reads `graph.json` from both versions
2. **Build Maps**: Creates `section_id → section` lookups
3. **Compare Sections**:
   - Added: in `to` but not in `from`
   - Removed: in `from` but not in `to`
   - Modified: in both but different `content_hash`
   - Unchanged: in both with same `content_hash` (skipped)
4. **Create Summary**: Counts each category
5. **Write Output**: Saves to `diffs/<from>__<to>.json`

## Performance

- Efficient hash-based comparison (O(n) time complexity)
- Memory-efficient: processes sections in single pass
- Fast: handles thousands of sections in milliseconds

## License

Part of the jolli project
