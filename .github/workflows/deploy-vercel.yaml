name: Deploy to Vercel

on:
    workflow_dispatch:
        inputs:
            environment:
                description: 'Environment to deploy to'
                required: true
                type: choice
                options:
                    - dev
                    - preview
                    - prod
            branch:
                description: 'Branch being deployed (for display)'
                required: false
                type: string
            sha:
                description: 'Commit SHA to deploy'
                required: false
                type: string

env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
    deploy:
        runs-on: ubuntu-24.04
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v5
              with:
                  lfs: true
                  ref: ${{ inputs.sha || github.sha }}

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version-file: .nvmrc

            - name: Display deployment info
              id: env
              run: |
                  echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
                  echo "::notice::Deploying branch: ${{ inputs.branch || 'manual' }}"
                  echo "::notice::Environment: ${{ inputs.environment }}"
                  echo "::notice::Commit: ${{ inputs.sha || github.sha }}"

            - name: Install dependencies
              run: npm ci

            - name: Build Vercel output
              env:
                  # Map workflow environment to VERCEL_ENV for build script
                  # prod -> production, dev/preview stay as-is
                  VERCEL_ENV: ${{ inputs.environment == 'prod' && 'production' || inputs.environment }}
              run: npm run vercel:build

            - name: Install Vercel CLI
              run: npm install -g vercel@latest

            - name: Deploy to Vercel
              id: deploy
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
                  ENVIRONMENT: ${{ steps.env.outputs.environment }}
              run: |
                  if [ "$ENVIRONMENT" = "prod" ]; then
                    DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
                  else
                    # Use --target to deploy to custom environments (dev, preview)
                    DEPLOY_URL=$(vercel deploy --prebuilt --target=$ENVIRONMENT --token=$VERCEL_TOKEN)
                  fi
                  echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
                  echo "::notice::Deployed to: $DEPLOY_URL"

            - name: Assign domain aliases
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
                  ENVIRONMENT: ${{ steps.env.outputs.environment }}
                  DEPLOY_URL: ${{ steps.deploy.outputs.url }}
              run: |
                  echo "Assigning domain aliases for $ENVIRONMENT to $DEPLOY_URL"
                  case "$ENVIRONMENT" in
                    dev)
                      vercel alias "$DEPLOY_URL" jolli.dev --token=$VERCEL_TOKEN --scope=jolli
                      vercel alias "$DEPLOY_URL" api.jolli.dev --token=$VERCEL_TOKEN --scope=jolli
                      ;;
                    preview)
                      vercel alias "$DEPLOY_URL" jolli.cloud --token=$VERCEL_TOKEN --scope=jolli
                      vercel alias "$DEPLOY_URL" api.jolli.cloud --token=$VERCEL_TOKEN --scope=jolli
                      ;;
                    prod)
                      vercel alias "$DEPLOY_URL" jolli.ai --token=$VERCEL_TOKEN --scope=jolli
                      vercel alias "$DEPLOY_URL" api.jolli.ai --token=$VERCEL_TOKEN --scope=jolli
                      ;;
                  esac
